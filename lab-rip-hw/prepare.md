RIP -  протокол обмена маршрутной информацией, который используется для построение маршрутных таблиц в пределах одной организации, например крупного предприятия. RIP протокол внешней маршрутизации (про внутреннюю и внешнюю маршрутизацию на стр 113)

## Таблица известных сетей
```
Network                 Next Hop         Metric From            Tag Time
R(n) 10.0.1.0/24        10.1.6.10             2 10.1.6.10         0 00:58
R(n) 10.0.2.0/24        10.5.6.50             3 10.5.6.50         0 00:52
C(i) 10.1.6.0/24        0.0.0.0               1 self              0
R(n) 10.2.4.0/24        10.5.6.50             3 10.5.6.50         0 00:52
R(n) 10.2.5.0/24        10.5.6.50             2 10.5.6.50         0 00:52
R(n) 10.3.4.0/24        10.5.6.50             4 10.5.6.50         0 00:52
C(i) 10.3.6.0/24        0.0.0.0               1 self              0
C(i) 10.5.6.0/24        0.0.0.0               1 self              0
```

Network - адрес и маска сети

Next Hop - ip адрес следующего маршрутизатора на пути до данной сети.

Metric - расстояние до пути измеряется в числе переходов между маршрутизаторами: сети, подключенные непосредственно, имеют метрику, равную единице, доступные через соседний маршрутизатор имеют метрику, равную двойке, и так далее.

From (хз чем оно отличается от next hop) - адрес следующего маршрутизатора для непосредственно подключeнных сетей условно равен 0.0.0.0

Time - Последняя колонка показывает текущее значение таймера устаревания. Такой таймер существует для каждой строки таблицы протокола RIP с метрикой сети, меньше «бесконечности». Его значение по стандарту равно 180 cек., но в нашей системе оно уменьшено до 60 cек. Если за данный промежуток маршрутизатор не получает сообщений с информацией о данном маршруте (то есть о пути до данной сети с тем же следующим маршрутизатором), то маршрут отмечается как недоступный и его метрика меняется на «бесконечность».

---
N - множество известных сетей
V - вектор расстояния маршрутизатора (это вектор из метрик и следующего маршрутизатора на пути к ней)
С - множество непосредственно подключенных сетей, для всех таких сетей метрика изначально равна V(c) = <1, r>. Метрики этих сетей не меняются в ходе работы rip

## Таймеры протокола RIP
Все маршрутизаторы регулярно рассылают свою таблицу известных сетей с помощью груповой рассылки на 224.0.0.9 раз в 30 сек, в нашей системе раз в 10 сек

групповая рассылка != широковещательная рассылка. широковещательная рассылка производится на 255.255.255.255 (mac з всех ffffff) то есть всем маршутизаторам

а групповая только определенной группе, насколько понял группе маршрутизаторов у которых есть прямой доступ к сети куда мы шлем сообщения

порт прикладного уравня (udp) 520

## Сообщения протокола RIP
Есть два вида сообщений, которые определяются полем command:
**1. сообщение-запрос**
не содержит в себе строк маршрутной таблицы, отправляется маршрутизатором сразу после включения.

2. сообщение-ответ
после получения сообщения-запроса другие маршрутизаторы отправляют сообщение-ответ со своей полной маршрутной таблицей, если в ней больше 25 записей, то отправляется несколько сообщений-ответов. Так же такие сообщения рассылаются по таймеру, в таком случае они не являются ответом на что либо

**Triggered RIP**
рассылка маршрутов не по таймеру, а при изменении. так как udp пакет несущий в себе измененный маршрут может пропасть то добавляется тип сообщение-подтверждение

## Перехват сообщений RIP

Правило расщипленного горизонта - если информация о маршруте была получена через некоторую сеть, то при отправке таблицы в этуже сеть этот маршрут не упоминается

Испорченное обратное обновление - такой маршрут включается в сообщение, но его метрика равна 16 (бесконечности)

### Пример работы расщипленного горизонта

Пример tcpdump рассылки rip сообщений на машине r4 на интерфейсе eth1. граф из методички
```
r4:~# tcpdump -tnv -i eth1 -s 1518 udp
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 1518 bytes
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 132) 10.2.4.40.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 104, routes: 5
	  AFI: IPv4:         0.0.0.0/0 , tag 0x0000, metric: 2, next-hop: self
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.3.4.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 2, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 152) 10.2.4.20.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 124, routes: 6
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.0.2.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.2.5.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.5.6.0/24, tag 0x0000, metric: 2, next-hop: self

```

Вывод команды show ip rip
```
r4# show ip rip
Codes: R - RIP, C - connected, S - Static, O - OSPF, B - BGP
Sub-codes:
      (n) - normal, (s) - static, (d) - default, (r) - redistribute,
      (i) - interface

     Network            Next Hop         Metric From            Tag Time
R(n) 0.0.0.0/0          10.3.4.30             2 10.3.4.30         0 00:59
R(n) 10.0.1.0/24        10.3.4.30             4 10.3.4.30         0 00:59
R(n) 10.0.2.0/24        10.2.4.20             2 10.2.4.20         0 00:57
R(n) 10.1.6.0/24        10.3.4.30             3 10.3.4.30         0 00:59
C(i) 10.2.4.0/24        0.0.0.0               1 self              0
R(n) 10.2.5.0/24        10.2.4.20             2 10.2.4.20         0 00:57
C(i) 10.3.4.0/24        0.0.0.0               1 self              0
R(n) 10.3.6.0/24        10.3.4.30             2 10.3.4.30         0 00:59
R(n) 10.5.6.0/24        10.2.4.20             3 10.2.4.20         0 00:57
```
r4 узнал о сети 10.5.6.0 от своего соседа r2 (eth2 10.0.4.20). Поэтому при выполнении групповой рассылки соседям, в первом сообщении из tcpdump (10.2.4.40.520 > 224.0.0.9.520) видно что интрефейс eth1 машины r4 не добавляет в таблицу запись о маршруте до 10.5.6.0, так как мы знаем что этот маршрут мы получили от этого соседа r2.

### Пример работы испорченного обратного отправления

Пример tcpdump рассылки rip сообщений на машине r4 на интерфейсе eth1. граф из методички

```
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 212) 10.2.4.40.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 184, routes: 9
	  AFI: IPv4:         0.0.0.0/0 , tag 0x0000, metric: 2, next-hop: self
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.0.2.0/24, tag 0x0000, metric: 16, next-hop: 10.2.4.20
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.2.4.0/24, tag 0x0000, metric: 16, next-hop: self
	  AFI: IPv4:        10.2.5.0/24, tag 0x0000, metric: 16, next-hop: 10.2.4.20
	  AFI: IPv4:        10.3.4.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 2, next-hop: self
	  AFI: IPv4:        10.5.6.0/24, tag 0x0000, metric: 3, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 152) 10.2.4.20.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 124, routes: 6
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.0.2.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.2.5.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.5.6.0/24, tag 0x0000, metric: 2, next-hop: self
```

Вывод команды show ip rip

```
r4# show ip rip
Codes: R - RIP, C - connected, S - Static, O - OSPF, B - BGP
Sub-codes:
      (n) - normal, (s) - static, (d) - default, (r) - redistribute,
      (i) - interface

     Network            Next Hop         Metric From            Tag Time
R(n) 0.0.0.0/0          10.3.4.30             2 10.3.4.30         0 00:54
R(n) 10.0.1.0/24        10.3.4.30             4 10.3.4.30         0 00:54
R(n) 10.0.2.0/24        10.2.4.20             2 10.2.4.20         0 00:59
R(n) 10.1.6.0/24        10.3.4.30             3 10.3.4.30         0 00:54
C(i) 10.2.4.0/24        0.0.0.0               1 self              0
R(n) 10.2.5.0/24        10.2.4.20             2 10.2.4.20         0 00:59
C(i) 10.3.4.0/24        0.0.0.0               1 self              0
R(n) 10.3.6.0/24        10.3.4.30             2 10.3.4.30         0 00:54
R(n) 10.5.6.0/24        10.3.4.30             3 10.3.4.30         0 00:54
```

Сети, которые не были бы отправлены из-за расщипленного горизонта, будут отправлены, но с метрикой=16 (бесконечность), в данном случае это сети 10.2.4.0 (потому что это общая сеть с соседом), 10.0.2.0 и 10.2.5.0 (так как получены от соседа r2)

### Отключение правила расщипленного горизонта

Пример tcpdump на r4

```
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 152) 10.2.4.20.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 124, routes: 6
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.0.2.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.2.5.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.5.6.0/24, tag 0x0000, metric: 2, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 212) 10.2.4.40.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 184, routes: 9
	  AFI: IPv4:         0.0.0.0/0 , tag 0x0000, metric: 2, next-hop: self
	  AFI: IPv4:        10.0.1.0/24, tag 0x0000, metric: 4, next-hop: self
	  AFI: IPv4:        10.0.2.0/24, tag 0x0000, metric: 2, next-hop: 10.2.4.20
	  AFI: IPv4:        10.1.6.0/24, tag 0x0000, metric: 3, next-hop: self
	  AFI: IPv4:        10.2.4.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.2.5.0/24, tag 0x0000, metric: 2, next-hop: 10.2.4.20
	  AFI: IPv4:        10.3.4.0/24, tag 0x0000, metric: 1, next-hop: self
	  AFI: IPv4:        10.3.6.0/24, tag 0x0000, metric: 2, next-hop: self
	  AFI: IPv4:        10.5.6.0/24, tag 0x0000, metric: 3, next-hop: 10.2.4.20
```

Таблица на r4 

```
r4# show ip rip
Codes: R - RIP, C - connected, S - Static, O - OSPF, B - BGP
Sub-codes:
      (n) - normal, (s) - static, (d) - default, (r) - redistribute,
      (i) - interface

     Network            Next Hop         Metric From            Tag Time
R(n) 0.0.0.0/0          10.3.4.30             2 10.3.4.30         0 01:00
R(n) 10.0.1.0/24        10.3.4.30             4 10.3.4.30         0 01:00
R(n) 10.0.2.0/24        10.2.4.20             2 10.2.4.20         0 00:56
R(n) 10.1.6.0/24        10.3.4.30             3 10.3.4.30         0 01:00
C(i) 10.2.4.0/24        0.0.0.0               1 self              0
R(n) 10.2.5.0/24        10.2.4.20             2 10.2.4.20         0 00:56
C(i) 10.3.4.0/24        0.0.0.0               1 self              0
R(n) 10.3.6.0/24        10.3.4.30             2 10.3.4.30         0 01:00
R(n) 10.5.6.0/24        10.2.4.20             3 10.2.4.20         0 00:56
```

Как видно из результата tcp dump, те строки таблицы, которые бы не отослались с включенным режимом расщипленного горизонта, теперь отсылаюстся и в next-hop имеют ip той машины, от которой r4 получил эти пути (это можно увидеть по полю from в таблице путей r4)